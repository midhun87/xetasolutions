<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard - Xeta Solutions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        #notification {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760704788/XETA_SOLUTIONS_LOGO_bcsbwh.png" alt="Xeta Solutions Logo" class="h-8 w-auto">
                <h1 class="text-xl font-bold text-slate-800 hidden sm:block">Xeta Solutions</h1>
            </div>
            <div class="flex items-center gap-4">
                <p id="welcomeHeader" class="text-slate-600 text-sm hidden md:block">Welcome!</p>
                <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Profile Card -->
                <div id="profileCardContainer" class="bg-white rounded-xl shadow-md">
                    <!-- Profile content is loaded here -->
                </div>

                <!-- Attendance Card -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-bold mb-4">Attendance</h2>
                    <div id="attendanceStatus" class="p-3 rounded-lg bg-slate-100 text-slate-600 text-center text-sm font-medium mb-4">
                        Loading status...
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="checkInBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:bg-slate-300 disabled:cursor-not-allowed" onclick="markAttendance('in')">Check-In</button>
                        <button id="checkOutBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:bg-slate-300 disabled:cursor-not-allowed" onclick="markAttendance('out')">Check-Out</button>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-lg font-bold mb-4">My Assigned Tasks</h2>
                <ul id="taskList" class="space-y-2">
                    <!-- Tasks loaded here -->
                </ul>
            </div>
        </div>
    </main>

    <!-- Notification Element -->
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0">
        <p id="notificationMessage">Notification</p>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let user = JSON.parse(localStorage.getItem('xetaUser'));
        const token = localStorage.getItem('xetaToken');
        
        window.onload = function() {
            if (!user || !token || user.role !== 'employee') {
                window.location.href = 'login.html';
                return;
            }
            loadProfile();
            loadTasks();
            checkAttendanceStatus();
            document.getElementById('welcomeHeader').textContent = `Welcome, ${user.name.split(' ')[0]}!`;
        };

        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notificationMessage.textContent = message;
            notification.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0 ${isSuccess ? 'bg-green-600' : 'bg-red-500'}`;
            
            setTimeout(() => notification.classList.remove('translate-y-20', 'opacity-0'), 100);
            setTimeout(() => notification.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function logout() {
            localStorage.removeItem('xetaUser');
            localStorage.removeItem('xetaToken');
            window.location.href = 'login.html';
        }

        function loadProfile() {
            const profileCardContainer = document.getElementById('profileCardContainer');
            profileCardContainer.innerHTML = `
                <div class="p-6 text-center">
                    <img src="${user.profilePicUrl || 'https://placehold.co/120x120/e2e8f0/334155?text=PIC'}" alt="Profile Picture" class="w-24 h-24 rounded-full mx-auto border-4 border-slate-200 object-cover">
                    <h2 class="mt-4 text-xl font-bold text-slate-800">${user.name}</h2>
                    <p class="text-sm text-slate-500">${user.designation}</p>
                </div>
                <div class="border-t px-6 py-4 space-y-3 text-sm">
                    <p class="flex justify-between"><strong class="text-slate-500 font-medium">Employee ID</strong> <span class="text-slate-700 font-semibold">${user.userId}</span></p>
                    <p class="flex justify-between"><strong class="text-slate-500 font-medium">Email</strong> <span class="text-slate-700 font-semibold">${user.email}</span></p>
                    <p class="flex justify-between"><strong class="text-slate-500 font-medium">Mobile</strong> <span class="text-slate-700 font-semibold">${user.mobile}</span></p>
                     <p class="flex justify-between"><strong class="text-slate-500 font-medium">Shift</strong> <span class="text-slate-700 font-semibold">${user.shift || 'N/A'}</span></p>
                </div>
                <div class="border-t p-6">
                    <form id="updatePicForm">
                        <label for="profilePic" class="text-sm font-medium text-slate-700 block mb-2">Update Picture</label>
                        <input type="file" name="profilePic" id="profilePic" accept="image/*" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                        <button type="submit" class="mt-4 w-full bg-slate-700 hover:bg-slate-800 text-white font-bold py-2.5 px-4 rounded-lg transition-colors text-sm">Upload Picture</button>
                    </form>
                    <button onclick="generateIdCard()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors text-sm">
                        Generate ID Card
                    </button>
                </div>
            `;
            document.getElementById('updatePicForm').addEventListener('submit', updateProfilePicture);
        }
        
        async function updateProfilePicture(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch(`${API_URL}/employee/update-picture`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    showNotification('Profile picture updated!');
                    user.profilePicUrl = result.newUrl;
                    localStorage.setItem('xetaUser', JSON.stringify(user));
                    loadProfile();
                } else {
                    showNotification('Failed to update picture: ' + result.message, false);
                }
            } catch (error) {
                console.error('Update Picture Error:', error);
                showNotification('An error occurred while updating.', false);
            }
        }
        
        async function markAttendance(type) {
            const endpoint = type === 'in' ? '/employee/check-in' : '/employee/check-out';
            try {
                const response = await fetch(API_URL + endpoint, { 
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                const result = await response.json();
                if(result.success) {
                    showNotification(`Successfully Checked ${type}!`);
                    checkAttendanceStatus();
                } else {
                    showNotification(result.message || `Failed to Check ${type}.`, false);
                }
            } catch (error) {
                showNotification('Error connecting to the server.', false);
            }
        }
        
        async function checkAttendanceStatus() {
            try {
                const response = await fetch(`${API_URL}/employee/attendance-status`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: `Server responded with status ${response.status}` }));
                    throw new Error(errorResult.message || `HTTP error! Status: ${response.status}`);
                }
                const result = await response.json();
                const statusEl = document.getElementById('attendanceStatus');
                const checkInBtn = document.getElementById('checkInBtn');
                const checkOutBtn = document.getElementById('checkOutBtn');

                if (result.status === 'checked_in') {
                    statusEl.innerHTML = `Checked in at <span class="font-bold">${new Date(result.record.checkInTime).toLocaleTimeString('en-IN')}</span>`;
                    checkInBtn.disabled = true;
                    checkOutBtn.disabled = false;
                } else if (result.status === 'checked_out') {
                    statusEl.innerHTML = `Checked out at <span class="font-bold">${new Date(result.record.checkOutTime).toLocaleTimeString('en-IN')}</span>`;
                    checkInBtn.disabled = true;
                    checkOutBtn.disabled = true;
                } else {
                    statusEl.textContent = `Status: Not Checked In`;
                    checkInBtn.disabled = false;
                    checkOutBtn.disabled = true;
                }
            } catch (error) {
                 document.getElementById('attendanceStatus').textContent = 'Could not fetch status.';
                 showNotification(error.message, false);
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/employee/tasks`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: `Server responded with status ${response.status}` }));
                    throw new Error(errorResult.message || `HTTP error! Status: ${response.status}`);
                }
                const tasks = await response.json();
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = '';
                if (tasks.length === 0) {
                    taskList.innerHTML = '<li class="text-slate-500 text-center py-4">No tasks assigned yet.</li>';
                    return;
                }
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'border-b last:border-0 py-3 flex justify-between items-center';
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${task.title}</p>
                            <p class="text-sm text-slate-500">${task.description}</p>
                        </div>
                        <div>
                            <select onchange="updateTaskStatus('${task.taskId}', this.value)" class="bg-slate-100 text-slate-700 text-sm rounded-md p-2 border-slate-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Reupdating" ${task.status === 'Reupdating' ? 'selected' : ''}>Reupdating</option>

                            </select>
                        </div>
                    `;
                    taskList.appendChild(li);
                });
            } catch (error) {
                document.getElementById('taskList').innerHTML = '<li class="text-red-500 text-center py-4">Failed to load tasks.</li>';
                showNotification(error.message, false);
            }
        }
        
        async function updateTaskStatus(taskId, status) {
            try {
                const response = await fetch(`${API_URL}/employee/task-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ taskId, status })
                });
                const result = await response.json();
                if(result.success) {
                    showNotification('Task status updated!');
                } else {
                    showNotification('Failed to update status.', false);
                }
            } catch (error) {
                 showNotification('Error connecting to the server.', false);
            }
        }

        function generateIdCard() {
            const empDataString = encodeURIComponent(JSON.stringify(user));
            window.open(`id-card.html?data=${empDataString}`, '_blank', 'width=400,height=650');
        }
    </script>
</body>
</html>

